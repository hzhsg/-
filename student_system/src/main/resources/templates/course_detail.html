<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
  <!--<![endif]-->
  <!-- Begin Head -->
  <head>
    <title>课程作业</title>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="author" content="" />
    <meta name="MobileOptimized" content="320" />
    <!--Start Style -->
    <link rel="stylesheet" type="text/css" href="static/css/fonts.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="static/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="static/css/font-awesome.min.css"
    />
    <link rel="stylesheet" type="text/css" href="static/css/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="static/css/style.css" />
    <link rel="stylesheet" id="theme-change" type="text/css" href="" />
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
  </head>

  <body>
    <!-- Main Body -->
    <div class="page-wrapper">
      <!-- Header Start -->
      <header class="header-wrapper main-header">
        <div class="header-inner-wrapper">
          <div class="logo-wrapper">
            <a href="" class="admin-logo">
              <img src="static/picture/title.png" alt="" />
            </a>
          </div>
          <div class="header-right">
            <div class="serch-wrapper">
              <form>
                <input type="text" placeholder="Search Here..." />
              </form>
              <a class="search-close" href="javascript:void(0);"><span class="icofont-close-line"></span></a>
            </div>
            <div class="header-left">
              <div class="header-links">
                <a href="javascript:void(0);" class="toggle-btn">
                  <span></span>
                </a>
              </div>
            </div>
            <div class="header-controls">

              <div class="user-info-wrapper header-links">
                <a href="javascript:void(0);" class="user-info">
                  <img src="static/picture/image.jpg" alt="" class="user-img"/>
                </a>
                <div class="user-info-box">
                  <div class="drop-down-header">
                    <h4 th:text="${name}">huzhihang</h4>
                    <p>教师</p>
                  </div>
                  <ul>
                    <li>
                      <a href="profile">
                        <i class="far fa-edit"></i> 个人信息
                      </a>
                    </li>
                    <li>
                      <form action="doLogout" method="post">
                        <button type="submit">
                          <i class="fas fa-sign-out-alt"></i> logout
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- Sidebar Start -->
      <aside class="sidebar-wrapper">
        <div class="side-menu-wrap">
          <ul class="main-menu">
            <li>
              <a href="/" class="active">
                <span class="icon-menu feather-icon">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-home"
                  >
                    <path
                      d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"
                    ></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                  </svg>
                </span>
                <span class="menu-text"> 首页 </span>
              </a>
            </li>
            <li>
              <a href="courseHaveJoined">
                <span class="icon-menu feather-icon">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-users"
                  >
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                  </svg>
                </span>
                <span class="menu-text"> 课程 </span>
              </a>
            </li>
            <li>
              <a href="assignment">
                <span class="icon-menu feather-icon">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-layers"
                  >
                    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                    <polyline points="22 17 12 22 2 17"></polyline>
                    <polyline points="2 12 12 17 22 12"></polyline>
                  </svg>
                </span>
                <span class="menu-text"> 作业 </span>
              </a>
            </li>
            <li>
              <a href="notification">
                <span class="icon-menu feather-icon">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-mail"
                  >
                    <path
                      d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                    ></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                  </svg>
                </span>
                <span class="menu-text"> 通知 </span>
              </a>
            </li>
          </ul>
        </div>
      </aside>
      <!-- Container Start -->
      <div class="page-wrapper">
        <div class="main-content">
          <!-- Page Title Start -->
          <div class="row">
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
              <div class="page-title-wrapper">
                <div class="page-title-box ad-title-box-use">
                  <h4 th:text="${courseName}" class="page-title bold">首页</h4>
                  <p>课程序号：<span th:text="${course_id}"></span></p>
                  <p>教师名：<span th:text="${teacher_name}"></span></p>
                  <p th:text="${courseDescription}"></p>
                </div>
                <div class="ad-breadcrumb">
                  <div class="add-group">
                    <input type="text" id="course_id" th:value="${course_id}" hidden>
                    <a href="javascript:quitCourse();" class="ad-btn">退出课程</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Table Start -->
          <div class="row">
            <!-- Styled Table Card-->
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
              <div class="card table-card">
                <ul>
                  <li class="container-grid">
                    <div class="card-header pb-0" style="text-align: center;">
                      <h4>作业列表</h4>
                      <a href="student_information" class="btn btn-primary mt-2 float-left mr-2">学生列表</a>
                    </div>
                  </li>
                </ul>
                <style>
                  .container-grid {
                    display: grid;
                    grid-template-columns: 1fr auto; /* 定义两列，第一列为1fr（flex fraction），第二列为自动大小 */
                    align-items: center; /* 垂直居中 */
                  }
                  .add-group {
                    text-align: right; /* 文本右对齐 */
                  }
                </style>

                <div class="card-body">
                  <div class="chart-holder">
                    <div class="table-responsive">
                      <table class="table table-styled mb-0">
                        <thead>
                          <tr>
                            <th>作业序号</th>
                            <th>作业名</th>
                            <th>创建日期</th>
                            <th>截止日期</th>
                            <th>提交状态</th>
                            <th>批改状态</th>
                            <th>查看详情</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr th:each="assignment,iterationStat:${assignment_list}" th:data-assignment-id="${assignment.getAssignment_id()}">
                            <td th:text="${iterationStat.index + 1}"></td> <!-- 序号列，从1开始 -->
                            <td th:text="${assignment.getTitle()}"></td>
                            <td th:text="${#dates.format(assignment.getCreated_time(), 'yyyy/MM/dd HH:mm')}"></td>
                            <td th:text="${#dates.format(assignment.getDeadline(), 'yyyy/MM/dd HH:mm')}"></td>
                            <td th:if="${assignment.isSubmission_status()}" th:style="'color: green;'">已提交</td>
                            <td th:unless="${assignment.isSubmission_status()}" th:style="'color: red;'">未提交</td>
                            <td th:if="${assignment.isCorrect_status()}" th:style="'color: green;'">
                              <a href="javascript:void(0);" onclick="getCorrectInformation(this.closest('tr').dataset.assignmentId)" class="badge badge-primary">查看评价</a>
                            </td>
                            <td th:unless="${assignment.isCorrect_status()}" th:style="'color: red;'">未批改</td>
                            <td>
                              <a href="javascript:void(0);" onclick="getAssignment(this.closest('tr').dataset.assignmentId)" class="badge badge-primary">查看详情</a>
                            </td>
                          </tr>
                          <!-- Additional rows omitted for brevity -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 上传作业模态框 -->
    <div class="modal fade" id="AssignmentModal" tabindex="-1" role="dialog" aria-labelledby="AssignmentModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="AssignmentModalLabel">作业详情</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="AssignmentName">作业标题</label>
                <input type="text" class="form-control" id="AssignmentName" placeholder="输入作业标题" readonly>
              </div>
              <div class="form-group">
                <label for="AssignmentDescription">作业描述</label>
                <textarea class="form-control" id="AssignmentDescription" rows="3" readonly></textarea>
              </div>
              <div class="form-group">
                <label for="AssignmentDeadline">截止时间</label>
                <input type="datetime-local" class="form-control" id="AssignmentDeadline" placeholder="选择截止时间" readonly>
              </div>
              <div class="form-group">
                <label for="AssignmentFile">作业文件</label>
                <input type="file" class="form-control" id="AssignmentFile" placeholder="作业文件" required>
              </div>
              <input type="hidden" id="AssignmentId">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            <button onclick="submitAssignment()" type="button" class="btn btn-primary">提交</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="CorrectModal" tabindex="-1" role="dialog" aria-labelledby="CorrectModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="CorrectModalLabel">批改</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="Score">评分</label>
                <input type="text" class="form-control" id="Score" placeholder="请输入评分" readonly>
              </div>
              <div class="form-group">
                <label for="Feedback">作业评语</label>
                <textarea class="form-control" id="Feedback" rows="3" placeholder="未写入评语" readonly></textarea>
              </div>
              <input type="hidden" id="SubmissionId">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">确认</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Script Start -->
    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/popper.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>
    <script src="static/js/custom.js"></script>
  </body>
</html>

<script>
  function quitCourse() {
    // 弹出确认框询问用户是否确定退出
    const isConfirmed = confirm("您确定要退出这门课程吗？");

    if (isConfirmed) {
      axios.post('/quitCourse', {
        courseId: document.getElementById('course_id').value
      }, {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }).then(({data}) => {
        alert(data);
        if(data==='退课成功'){
          window.location.reload();
        }
      })
    }
  }

  function getAssignment(assignmentId) {
    // 使用axios向后端发送请求，获取课程数据
    axios.post('/getAssignment',{
      assignmentId:assignmentId
    },{
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    }).then(({data})=> {
      var deadline = data.deadline;
      // 移除毫秒和时区信息，只保留日期和时间部分
      deadline = deadline.slice(0,16);

      // 填充模态框数据
      document.getElementById('AssignmentName').value = data.title;
      document.getElementById('AssignmentDescription').value = data.description;
      document.getElementById('AssignmentDeadline').value = deadline;
      document.getElementById('AssignmentId').value = data.assignment_id;

      // 显示模态框
      $('#AssignmentModal').modal('show');
    })
  }

  function submitAssignment(){
    var fileInput = document.getElementById('AssignmentFile');
    if (fileInput.files.length > 0) {
      var file = fileInput.files[0];
      var fileName = file.name; // 获取文件名
      var dotIndex = fileName.lastIndexOf('.'); // 获取最后一个点的位置
      var fileExtension = fileName.slice(dotIndex); // 获取文件扩展名，包括点

      var formData = new FormData();
      formData.append('assignmentId', document.getElementById('AssignmentId').value);
      formData.append('file', file);
      formData.append('fileType', fileExtension);

      axios.post('/submitAssignment', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      }).then(({data}) => {
        alert(data);
        // 可以在这里关闭模态框或者刷新页面
        if(data==='作业上传成功'){
          $('#AssignmentModal').modal('hide');
          window.location.reload();
        }
      })
    }
  }

  function getCorrectInformation(assignmentId){
    axios.post('/getCorrectInformation',{
      assignmentId:assignmentId
    },{
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    }).then(({data})=>{
      document.getElementById('Score').value = data.score;
      document.getElementById('Feedback').value = data.feedback;
      document.getElementById('SubmissionId').value = data.submission_id;

      // 显示模态框
      $('#CorrectModal').modal('show');
    })
  }
</script>
